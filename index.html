<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VYRALL — Content Built to Spread</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;1,9..144,300;1,9..144,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#08080a; --s1:#0f0f12; --s2:#16161a; --s3:#1e1e24; --s4:#26262e;
  --b1:#2a2a34; --b2:#38383f; --b3:#4a4a55;
  --ink:#eeece6; --ink2:#9e9c96; --ink3:#5e5c58;
  --g:#00e5a0; --g2:#00b880; --g3:rgba(0,229,160,.12); --g4:rgba(0,229,160,.06);
  --amber:#f0a030; --amber2:rgba(240,160,48,.08); --amber3:rgba(240,160,48,.22);
  --red:#ff5555; --red2:rgba(255,85,85,.08);
  --blue:#4a9eff; --blue2:rgba(74,158,255,.08);
  --purple:#b06aff; --purple2:rgba(176,106,255,.08);
  --yellow:#ffd060; --yellow2:rgba(255,208,96,.08);
  --teal:#00d4d4; --teal2:rgba(0,212,212,.08);
}

*{margin:0;padding:0;box-sizing:border-box;}

body {
  background:var(--bg); color:var(--ink);
  font-family:'DM Mono',monospace; font-size:12px;
  min-height:100vh; overflow-x:hidden;
}

body::after {
  content:''; position:fixed; inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events:none; z-index:9999; opacity:.45;
}

/* ── HEADER ── */
header {
  background:var(--s1); border-bottom:1px solid var(--b1);
  height:56px; display:flex; align-items:center; justify-content:space-between;
  padding:0 36px; position:sticky; top:0; z-index:200;
}

.logo { font-family:'Syne',sans-serif; font-weight:800; font-size:20px; letter-spacing:.14em; color:var(--ink); }
.logo em { color:var(--g); font-style:normal; }
.logo-sub { font-size:9px; letter-spacing:.22em; text-transform:uppercase; color:var(--ink3); margin-left:14px; padding-left:14px; border-left:1px solid var(--b2); }

.hdr-nav { display:flex; gap:4px; }
.nav-btn { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.1em; padding:6px 14px; border-radius:3px; border:1px solid transparent; background:transparent; color:var(--ink3); cursor:pointer; transition:all .2s; }
.nav-btn:hover { color:var(--ink2); border-color:var(--b2); }
.nav-btn.on { color:var(--g); border-color:var(--g3); background:var(--g4); }

/* ── LAYOUT ── */
.app { display:grid; grid-template-columns:300px 1fr; min-height:calc(100vh - 56px); }

/* ── SIDEBAR ── */
.sidebar {
  background:var(--s1); border-right:1px solid var(--b1);
  display:flex; flex-direction:column; overflow-y:auto;
  max-height:calc(100vh - 56px); position:sticky; top:56px;
}

.sb { padding:16px 20px; border-bottom:1px solid var(--b1); }
.sb-lbl { font-size:9px; letter-spacing:.26em; text-transform:uppercase; color:var(--ink3); margin-bottom:10px; font-weight:500; }

.field { display:flex; flex-direction:column; gap:4px; margin-bottom:9px; }
.field:last-child { margin-bottom:0; }
.fl { font-size:9.5px; letter-spacing:.1em; text-transform:uppercase; color:var(--ink2); }

input[type=text], select {
  background:var(--s2); border:1px solid var(--b1); color:var(--ink);
  font-family:'DM Mono',monospace; font-size:11.5px; padding:8px 11px;
  border-radius:3px; outline:none; transition:border-color .15s, background .15s;
  width:100%; appearance:none; -webkit-appearance:none;
}

input[type=text]:focus, select:focus { border-color:var(--g2); background:var(--s3); }
input.err { border-color:var(--red)!important; }

.sw { position:relative; }
.sw::after { content:'▾'; position:absolute; right:10px; top:50%; transform:translateY(-50%); font-size:10px; color:var(--ink3); pointer-events:none; }
select { padding-right:26px; cursor:pointer; }
select option { background:var(--s2); color:var(--ink); }
select optgroup { font-style:normal; font-weight:500; font-size:9px; color:var(--ink3); letter-spacing:.1em; }

/* AI DECISION BADGE */
.ai-decides {
  display:flex; align-items:center; gap:6px;
  padding:7px 10px; border-radius:3px;
  background:var(--g4); border:1px solid var(--g3);
  font-size:10px; color:var(--g2);
}
.ai-decides .icon { font-size:11px; }

/* OFFER TOGGLE */
.tog-row { display:flex; align-items:center; gap:9px; cursor:pointer; user-select:none; margin-bottom:9px; }
.tog { width:30px; height:16px; background:var(--b2); border-radius:8px; position:relative; transition:background .2s; flex-shrink:0; }
.tog::after { content:''; width:10px; height:10px; background:var(--bg); border-radius:50%; position:absolute; top:3px; left:3px; transition:transform .2s; box-shadow:0 1px 3px rgba(0,0,0,.6); }
.tog.on { background:var(--g); }
.tog.on::after { transform:translateX(14px); }
.tog-lbl { font-size:10.5px; color:var(--ink2); }
.offer-f { display:none; }
.offer-f.vis { display:flex; flex-direction:column; gap:8px; margin-top:2px; }

/* RUN BTN */
.run-btn {
  background:var(--g); color:var(--bg); border:none; padding:12px 18px;
  font-family:'Syne',sans-serif; font-size:11px; font-weight:700;
  letter-spacing:.2em; text-transform:uppercase; cursor:pointer; border-radius:3px;
  width:100%; transition:all .2s;
}
.run-btn:hover:not(:disabled) { background:#00ffb3; }
.run-btn:disabled { background:var(--b1); color:var(--ink3); cursor:not-allowed; }

/* STATUS */
.status { display:flex; align-items:center; gap:7px; padding:9px 20px; font-size:10px; color:var(--ink3); border-bottom:1px solid var(--b1); min-height:34px; }
.sdot { width:5px; height:5px; border-radius:50%; background:var(--b2); flex-shrink:0; transition:all .3s; }
.sdot.run { background:var(--g); box-shadow:0 0 6px var(--g); animation:blink 1.1s infinite; }
.sdot.ok { background:var(--g); }
.sdot.fail { background:var(--red); }
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

/* ACCORDION */
.acc-hdr { display:flex; align-items:center; justify-content:space-between; padding:13px 20px; cursor:pointer; border-bottom:1px solid var(--b1); transition:background .12s; }
.acc-hdr:hover { background:var(--s2); }
.acc-t { font-size:9px; letter-spacing:.25em; text-transform:uppercase; color:var(--ink3); }
.chv { font-size:10px; color:var(--ink3); transition:transform .22s; }
.chv.open { transform:rotate(180deg); }
.acc-b { max-height:0; overflow:hidden; transition:max-height .3s ease; }
.acc-b.open { max-height:400px; overflow-y:auto; }
.fe { padding:9px 20px; border-bottom:1px solid var(--b1); transition:background .1s; }
.fe:hover { background:var(--s2); }
.fe:last-child { border-bottom:none; }
.fe-n { font-size:9px; color:var(--ink3); }
.fe-nm { font-size:11px; color:var(--ink2); font-weight:500; }
.fe-d { font-size:10px; color:var(--ink3); line-height:1.5; margin-top:2px; }

/* ── MAIN ── */
.main { padding:32px 40px; display:flex; flex-direction:column; gap:18px; }

/* WELCOME */
.welcome { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:460px; text-align:center; gap:14px; padding:40px; }
.wv { font-family:'Syne',sans-serif; font-weight:800; font-size:80px; letter-spacing:.08em; color:var(--g); line-height:1; text-shadow:0 0 80px rgba(0,229,160,.25); animation:fadeIn .6s ease; }
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.wt { font-family:'Fraunces',serif; font-size:24px; font-weight:300; color:var(--ink); letter-spacing:.04em; }
.ws { font-size:11px; color:var(--ink3); line-height:1.9; max-width:420px; }
.w-pill { display:flex; align-items:center; gap:8px; background:var(--s2); border:1px solid var(--b1); padding:8px 14px; border-radius:3px; font-size:9.5px; color:var(--ink3); letter-spacing:.08em; }
.w-pill span { color:var(--g); }

/* AI INTELLIGENCE NOTE */
.ai-note {
  background:var(--g4); border:1px solid var(--g3); border-radius:3px;
  padding:10px 14px; font-size:10.5px; color:var(--g2); line-height:1.7;
  max-width:440px; text-align:left;
}
.ai-note strong { color:var(--g); }

/* OUTPUT */
.out { display:flex; flex-direction:column; gap:16px; }
@keyframes up{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ── ANALYSIS CARD ── */
.analysis-card { background:var(--s1); border:1px solid var(--b1); border-radius:5px; overflow:hidden; animation:up .3s ease; }

.card-hdr { display:flex; align-items:center; justify-content:space-between; padding:12px 18px; background:var(--s2); border-bottom:1px solid var(--b1); }
.card-hdr-l { display:flex; flex-direction:column; gap:2px; }
.card-eye { font-size:8.5px; letter-spacing:.25em; text-transform:uppercase; color:var(--ink3); }
.card-title { font-family:'Syne',sans-serif; font-size:13px; font-weight:700; color:var(--ink); }
.fmt-badge { font-family:'Fraunces',serif; font-size:17px; font-style:italic; color:var(--g); }

/* SCORES */
.scores-grid { display:grid; grid-template-columns:repeat(4,1fr); border-bottom:1px solid var(--b1); }
.score-cell { padding:14px 16px; border-right:1px solid var(--b1); }
.score-cell:last-child { border-right:none; }
.sc-lbl { font-size:8px; letter-spacing:.16em; text-transform:uppercase; color:var(--ink3); margin-bottom:6px; }
.sc-bar-w { height:3px; background:var(--b1); border-radius:2px; margin-bottom:6px; }
.sc-bar { height:100%; border-radius:2px; transition:width .7s ease; }
.sc-bar.g { background:var(--g); }
.sc-bar.a { background:var(--amber); }
.sc-bar.b { background:var(--blue); }
.sc-bar.p { background:var(--purple); }
.sc-val { font-family:'Syne',sans-serif; font-size:19px; font-weight:700; color:var(--ink); }
.sc-src { font-size:8.5px; color:var(--ink3); margin-top:2px; }

/* AI SELECTIONS ROW */
.ai-sel-row {
  display:flex; align-items:stretch; gap:0;
  border-bottom:1px solid var(--b1);
}

.ai-sel-cell {
  flex:1; padding:12px 16px;
  border-right:1px solid var(--b1);
  display:flex; flex-direction:column; gap:4px;
}
.ai-sel-cell:last-child { border-right:none; }

.as-lbl { font-size:8px; letter-spacing:.18em; text-transform:uppercase; color:var(--ink3); }
.as-val { font-size:12px; font-weight:500; }
.as-val.emo-awe { color:var(--blue); }
.as-val.emo-anger { color:var(--red); }
.as-val.emo-anxiety { color:var(--purple); }
.as-val.emo-amusement { color:var(--yellow); }
.as-val.emo-inspiration { color:var(--g); }
.as-val.emo-surprise { color:var(--amber); }
.as-reason { font-size:10px; color:var(--ink3); line-height:1.5; }

.trigger-tags { display:flex; flex-wrap:wrap; gap:4px; }
.trig-tag { font-size:9px; padding:2px 8px; border-radius:2px; border:1px solid var(--purple2); color:var(--purple); background:var(--purple2); }

/* INSIGHTS */
.insights-row { display:flex; flex-wrap:wrap; gap:5px; padding:11px 16px; border-bottom:1px solid var(--b1); }
.ip { font-size:9.5px; padding:3px 10px; border-radius:2px; border:1px solid var(--b1); color:var(--ink3); display:flex; align-items:center; gap:5px; }
.ip.good { border-color:rgba(0,229,160,.2); color:var(--g); }
.ip.warn { border-color:rgba(240,160,48,.2); color:var(--amber); }
.ip.info { border-color:rgba(74,158,255,.2); color:var(--blue); }

/* TWO COL */
.two-col { display:grid; grid-template-columns:1fr 1fr; }
.tc { padding:16px 18px; border-right:1px solid var(--b1); }
.tc:last-child { border-right:none; }
.tc-lbl { font-size:8.5px; letter-spacing:.2em; text-transform:uppercase; color:var(--ink3); margin-bottom:10px; }

/* REQUIREMENTS */
.req-list { display:flex; flex-direction:column; gap:5px; }
.req-item { display:flex; gap:7px; align-items:flex-start; padding:7px 9px; background:var(--s2); border-radius:3px; border-left:2px solid var(--b2); transition:border-color .15s; }
.req-item:hover { border-left-color:var(--g); }
.req-dash { color:var(--g); font-size:11px; flex-shrink:0; margin-top:1px; }
.req-txt { font-size:11px; color:var(--ink2); line-height:1.55; }
.req-txt strong { color:var(--ink); }

.struct-chain { display:flex; flex-wrap:wrap; align-items:center; gap:4px; }
.sc-step { font-size:9.5px; padding:3px 8px; border:1px solid var(--b1); border-radius:2px; color:var(--ink2); background:var(--s2); }
.sc-arr { color:var(--b3); font-size:9px; }

.card-reason { padding:12px 18px; font-size:11px; color:var(--ink2); line-height:1.75; font-style:italic; }

/* PLATFORM BOX */
.plat-box { padding:14px 18px; background:var(--amber2); border-top:1px solid var(--b1); }
.plat-lbl { font-size:8.5px; letter-spacing:.2em; text-transform:uppercase; color:var(--amber); margin-bottom:7px; }
.plat-items { display:flex; flex-direction:column; gap:4px; }
.plat-item { font-size:11px; color:var(--ink2); line-height:1.5; padding-left:12px; position:relative; }
.plat-item::before { content:'→'; position:absolute; left:0; color:var(--amber); font-size:9px; top:1px; }

/* ── FINAL CARD ── */
.final-card { background:var(--s1); border:1px solid var(--g3); border-radius:5px; overflow:hidden; animation:up .3s ease .08s both; }

.final-hdr { display:flex; align-items:center; justify-content:space-between; padding:13px 18px; background:var(--s2); border-bottom:1px solid var(--b1); }
.final-hdr-l { display:flex; flex-direction:column; gap:2px; }
.final-eye { font-size:8.5px; letter-spacing:.25em; text-transform:uppercase; color:var(--g2); }
.final-t { font-family:'Syne',sans-serif; font-size:14px; font-weight:700; letter-spacing:.08em; color:var(--ink); }

.fbadge { font-size:8.5px; letter-spacing:.14em; text-transform:uppercase; padding:3px 9px; border-radius:2px; border:1px solid var(--b2); color:var(--ink3); }
.fbadge.run { border-color:var(--g2); color:var(--g); animation:blink 1.1s infinite; }
.fbadge.ok { border-color:var(--g2); color:var(--g); }
.fbadge.fail { border-color:var(--red); color:var(--red); }

.final-body { padding:26px; }

.hook-block { border-left:3px solid var(--g); padding:10px 15px; background:var(--s2); border-radius:0 3px 3px 0; margin-bottom:18px; }
.hook-tag { font-size:8.5px; letter-spacing:.22em; text-transform:uppercase; color:var(--g2); margin-bottom:5px; }
.hook-txt { font-family:'Fraunces',serif; font-size:18px; font-style:italic; line-height:1.45; color:var(--ink); }

.script-b { font-size:13px; line-height:1.9; color:var(--ink2); white-space:pre-wrap; word-break:break-word; margin-bottom:18px; }

.cta-block { background:var(--amber2); border:1px solid var(--amber3); border-radius:3px; padding:13px 17px; margin-bottom:18px; }
.cta-lbl { font-size:8.5px; letter-spacing:.22em; text-transform:uppercase; color:var(--amber); margin-bottom:5px; }
.cta-txt { font-family:'Fraunces',serif; font-size:15px; font-style:italic; color:var(--amber); line-height:1.5; }

.no-offer { background:var(--s2); border:1px dashed var(--b2); border-radius:3px; padding:10px 14px; font-size:10.5px; color:var(--ink3); line-height:1.6; margin-bottom:16px; font-style:italic; }

/* SHARE EXPLANATION */
.share-block { background:var(--purple2); border:1px solid rgba(176,106,255,.2); border-radius:3px; padding:13px 17px; margin-bottom:18px; }
.share-lbl { font-size:8.5px; letter-spacing:.22em; text-transform:uppercase; color:var(--purple); margin-bottom:5px; }
.share-txt { font-size:11.5px; color:var(--ink2); line-height:1.6; }

/* ACTION ROW */
.act-row { display:flex; align-items:center; justify-content:space-between; padding-top:16px; border-top:1px solid var(--b1); gap:8px; flex-wrap:wrap; }
.act-g { display:flex; gap:6px; flex-wrap:wrap; }
.abtn { background:var(--s2); border:1px solid var(--b1); color:var(--ink2); font-family:'DM Mono',monospace; font-size:9.5px; letter-spacing:.08em; padding:7px 12px; cursor:pointer; border-radius:3px; transition:all .15s; white-space:nowrap; }
.abtn:hover { border-color:var(--g2); color:var(--g); }
.abtn.primary { background:var(--g); color:var(--bg); border-color:var(--g); font-weight:500; }
.abtn.primary:hover { background:#00ffb3; border-color:#00ffb3; }
.abtn:disabled { opacity:.35; cursor:not-allowed; }

/* SKELETON */
.skel-wrap { display:flex; flex-direction:column; gap:9px; padding:4px 0; }
.sk { height:11px; background:linear-gradient(90deg,var(--s2) 25%,var(--s3) 50%,var(--s2) 75%); background-size:200% 100%; animation:shim 1.4s infinite; border-radius:2px; }
@keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}

.err-msg { color:var(--red); font-size:11px; line-height:1.7; padding:11px 13px; background:var(--red2); border:1px solid rgba(255,85,85,.2); border-radius:3px; }

/* HISTORY */
.hist-view { display:none; flex-direction:column; gap:14px; }
.hist-view.vis { display:flex; }
.hist-empty { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:300px; gap:10px; color:var(--ink3); text-align:center; }
.hist-list { display:flex; flex-direction:column; gap:11px; }
.hi { background:var(--s1); border:1px solid var(--b1); border-radius:5px; overflow:hidden; transition:border-color .2s; }
.hi:hover { border-color:var(--b2); }
.hi-hdr { display:flex; align-items:center; justify-content:space-between; padding:11px 15px; background:var(--s2); border-bottom:1px solid var(--b1); }
.hi-topic { font-family:'Syne',sans-serif; font-size:13px; font-weight:600; color:var(--ink); }
.hi-meta { font-size:9.5px; color:var(--ink3); margin-top:2px; }
.hi-time { font-size:9.5px; color:var(--ink3); white-space:nowrap; }
.hi-prev { padding:12px 15px; font-family:'Fraunces',serif; font-size:13px; font-style:italic; color:var(--ink2); line-height:1.6; }
.hi-tags { padding:6px 15px; display:flex; gap:5px; flex-wrap:wrap; border-top:1px solid var(--b1); }
.hi-tag { font-size:9px; padding:2px 8px; border-radius:2px; border:1px solid var(--b1); color:var(--ink3); }
.hi-acts { display:flex; gap:5px; padding:9px 15px; border-top:1px solid var(--b1); }
.hbtn { font-family:'DM Mono',monospace; font-size:9.5px; letter-spacing:.07em; padding:5px 11px; border-radius:2px; border:1px solid var(--b1); background:transparent; color:var(--ink3); cursor:pointer; transition:all .15s; }
.hbtn:hover { border-color:var(--g2); color:var(--g); }
.hbtn.hl { border-color:var(--g3); color:var(--g); }

::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px;}

@media(max-width:800px){
  .app{grid-template-columns:1fr;}
  .sidebar{max-height:none;position:static;}
  header{padding:0 16px;}
  .main{padding:20px 16px;}
  .two-col{grid-template-columns:1fr;}
  .tc{border-right:none;border-bottom:1px solid var(--b1);}
  .scores-grid{grid-template-columns:1fr 1fr;}
  .ai-sel-row{flex-wrap:wrap;}
  .ai-sel-cell{border-bottom:1px solid var(--b1);}
}
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center">
    <div class="logo">VYR<em>ALL</em></div>
    <div class="logo-sub">Content built to spread</div>
  </div>
  <div class="hdr-nav">
    <button class="nav-btn on" id="nb-gen" onclick="sw('gen')">Generate</button>
    <button class="nav-btn" id="nb-hist" onclick="sw('hist')">History <span id="hc" style="color:var(--g2)"></span></button>
  </div>
</header>

<div class="app">

  <!-- ══════════ SIDEBAR ══════════ -->
  <aside class="sidebar">

    <div class="sb">
      <div class="sb-lbl">01 · Content</div>
      <div class="field">
        <label class="fl">Topic / Idea</label>
        <input type="text" id="topicInput" placeholder="e.g. why most people never save money"/>
      </div>
      <div class="field">
        <label class="fl">Niche <span style="color:var(--ink3);font-size:9px">(optional)</span></label>
        <input type="text" id="nicheInput" placeholder="finance, fitness, real estate…"/>
      </div>
    </div>

    <div class="sb">
      <div class="sb-lbl">02 · Goal</div>
      <div class="sw">
        <select id="goalSel">
          <optgroup label="── REACH & GROWTH ──">
            <option value="virality">Virality — maximize reach &amp; views</option>
            <option value="discoverability">Discoverability — reach new audiences</option>
            <option value="shareability">Shareability — content people pass on</option>
          </optgroup>
          <optgroup label="── CREDIBILITY ──">
            <option value="authority">Authority — position as expert</option>
            <option value="thought_leadership">Thought Leadership — shape industry thinking</option>
            <option value="education">Education — teach a skill or concept</option>
          </optgroup>
          <optgroup label="── RELATIONSHIP ──">
            <option value="trust">Trust — build emotional connection</option>
            <option value="relatability">Relatability — make people feel seen</option>
            <option value="community">Community — deepen audience bond</option>
          </optgroup>
          <optgroup label="── CONVERSION ──">
            <option value="sales_alignment">Sales Alignment — support backend offer</option>
            <option value="lead_generation">Lead Generation — attract prospects</option>
            <option value="nurture">Nurture — move audience toward decision</option>
          </optgroup>
          <optgroup label="── IDENTITY & MISSION ──">
            <option value="inspiration">Inspiration — motivate &amp; activate identity</option>
            <option value="brand_awareness">Brand Awareness — establish presence</option>
            <option value="movement_building">Movement Building — rally around a belief</option>
          </optgroup>
        </select>
      </div>
    </div>

    <div class="sb">
      <div class="sb-lbl">03 · Tone &amp; Style</div>
      <div class="sw">
        <select id="toneSel">
          <optgroup label="── CALM / REFLECTIVE ──">
            <option value="calm_thoughtful">Calm &amp; Thoughtful</option>
            <option value="philosophical">Philosophical / Meditative</option>
            <option value="poetic_lyrical">Poetic / Lyrical</option>
            <option value="introspective">Introspective / Vulnerable</option>
          </optgroup>
          <optgroup label="── DIRECT / AUTHORITATIVE ──">
            <option value="direct_tactical">Direct &amp; Tactical</option>
            <option value="bold_declarative">Bold &amp; Declarative</option>
            <option value="no_nonsense">No-Nonsense / Blunt</option>
            <option value="professional_formal">Professional &amp; Formal</option>
          </optgroup>
          <optgroup label="── ENERGETIC / ENGAGING ──">
            <option value="high_energy">High Energy / Enthusiastic</option>
            <option value="conversational">Conversational &amp; Warm</option>
            <option value="humorous_witty">Humorous &amp; Witty</option>
            <option value="provocative">Provocative / Edgy</option>
          </optgroup>
          <optgroup label="── NARRATIVE / STORYTELLING ──">
            <option value="storytelling">Storytelling / Narrative</option>
            <option value="journalistic">Journalistic / Investigative</option>
            <option value="documentary">Documentary / BTS</option>
            <option value="confessional">Confessional / Personal</option>
          </optgroup>
          <optgroup label="── SPECIALIZED ──">
            <option value="academic_analytical">Academic &amp; Analytical</option>
            <option value="coach_mentor">Coach / Mentor Voice</option>
            <option value="peer_to_peer">Peer-to-Peer / Relatable</option>
            <option value="contrarian">Contrarian / Myth-busting</option>
          </optgroup>
        </select>
      </div>
    </div>

    <div class="sb">
      <div class="sb-lbl">04 · Platform</div>
      <div class="sw">
        <select id="platSel">
          <option value="any">Any platform</option>
          <option value="tiktok">TikTok</option>
          <option value="instagram_reels">Instagram Reels</option>
          <option value="instagram_carousel">Instagram Carousel</option>
          <option value="youtube_shorts">YouTube Shorts</option>
          <option value="youtube_longform">YouTube — Long Form</option>
          <option value="facebook">Facebook</option>
          <option value="linkedin">LinkedIn</option>
          <option value="twitter_x">Twitter / X</option>
          <option value="podcast">Podcast</option>
          <option value="newsletter">Newsletter / Email</option>
        </select>
      </div>
    </div>

    <!-- AI DECIDES EMOTION + TRIGGERS -->
    <div class="sb">
      <div class="sb-lbl">05 · Emotion &amp; Share Strategy</div>
      <div class="ai-decides">
        <span class="icon">◈</span>
        <span>AI selects optimal emotion &amp; share triggers automatically based on your topic, goal, and platform</span>
      </div>
    </div>

    <div class="sb">
      <div class="sb-lbl">06 · Backend Offer</div>
      <div class="tog-row" onclick="togOffer()">
        <div class="tog" id="offerTog"></div>
        <span class="tog-lbl">I have an offer to promote</span>
      </div>
      <div class="offer-f" id="offerF">
        <div class="field">
          <label class="fl">Your offer</label>
          <input type="text" id="offerIn" placeholder="e.g. coaching program, course…"/>
        </div>
        <div class="field">
          <label class="fl">CTA</label>
          <input type="text" id="ctaIn" placeholder="e.g. DM me READY, link in bio…"/>
        </div>
      </div>
    </div>

    <div class="sb">
      <button class="run-btn" id="runBtn" onclick="run()">▶ &nbsp;Generate Content</button>
    </div>

    <div class="status" id="statusBar">
      <div class="sdot" id="sdot"></div>
      <span id="stxt">Ready</span>
    </div>

    <div class="acc-hdr" onclick="togAcc('fmtB','fmtC')">
      <span class="acc-t">Format Library — 40 Formats</span>
      <span class="chv" id="fmtC">▾</span>
    </div>
    <div class="acc-b" id="fmtB"><div id="fmtList"></div></div>

  </aside>

  <!-- ══════════ MAIN ══════════ -->
  <main class="main">

    <!-- GENERATE VIEW -->
    <div id="genView">
      <div id="welcomeEl" class="welcome">
        <div class="wv">V</div>
        <div class="wt">Content built to spread.</div>
        <div class="ws">The only content tool combining Brendan Kane's virality framework with Jonah Berger's emotion science, social currency theory, platform mechanics, and share trigger psychology — fully automated.</div>
        <div class="w-pill"><span>FORMAT + EMOTION + SOCIAL CURRENCY + SHARE TRIGGER + PLATFORM</span> = <span>VIRAL</span></div>
        <div class="ai-note">
          <strong>Fully AI-driven strategy.</strong> You provide topic, goal, tone, and platform. VYRALL's engine automatically selects the optimal high-arousal emotion (Berger's STEPPS), the best-fit format (Kane Framework), the most powerful share triggers, and generates the punchiest possible version — first time.
        </div>
      </div>

      <div id="outEl" class="out" style="display:none">

        <!-- Analysis Card -->
        <div class="analysis-card" id="analysisCard">
          <div class="card-hdr">
            <div class="card-hdr-l">
              <div class="card-eye">Virality Intelligence Report</div>
              <div class="card-title">Content Analysis</div>
            </div>
            <div class="fmt-badge" id="fmtBadge">—</div>
          </div>

          <!-- Scores -->
          <div class="scores-grid">
            <div class="score-cell">
              <div class="sc-lbl">Hook Strength</div>
              <div class="sc-bar-w"><div class="sc-bar g" id="sb-hook" style="width:0%"></div></div>
              <div class="sc-val" id="sv-hook">—</div>
              <div class="sc-src">Kane Framework</div>
            </div>
            <div class="score-cell">
              <div class="sc-lbl">Emotion Arousal</div>
              <div class="sc-bar-w"><div class="sc-bar a" id="sb-emo" style="width:0%"></div></div>
              <div class="sc-val" id="sv-emo">—</div>
              <div class="sc-src">Berger STEPPS</div>
            </div>
            <div class="score-cell">
              <div class="sc-lbl">Share Trigger</div>
              <div class="sc-bar-w"><div class="sc-bar b" id="sb-share" style="width:0%"></div></div>
              <div class="sc-val" id="sv-share">—</div>
              <div class="sc-src">Social Currency</div>
            </div>
            <div class="score-cell">
              <div class="sc-lbl">Platform Fit</div>
              <div class="sc-bar-w"><div class="sc-bar p" id="sb-plat" style="width:0%"></div></div>
              <div class="sc-val" id="sv-plat">—</div>
              <div class="sc-src">Algorithm Signal</div>
            </div>
          </div>

          <!-- AI Selections — transparently shown -->
          <div class="ai-sel-row" id="aiSelRow">
            <div class="ai-sel-cell">
              <div class="as-lbl">AI Selected Emotion</div>
              <div class="as-val" id="as-emo">—</div>
              <div class="as-reason" id="as-emo-why">—</div>
            </div>
            <div class="ai-sel-cell">
              <div class="as-lbl">Share Triggers Activated</div>
              <div class="trigger-tags" id="as-trigs"></div>
              <div class="as-reason" id="as-trigs-why" style="margin-top:5px">—</div>
            </div>
            <div class="ai-sel-cell">
              <div class="as-lbl">Social Currency Strategy</div>
              <div class="as-reason" id="as-social">—</div>
            </div>
          </div>

          <!-- Insights -->
          <div class="insights-row" id="insightsRow"></div>

          <!-- Format requirements + structure -->
          <div class="two-col">
            <div class="tc">
              <div class="tc-lbl">What This Format Demands</div>
              <div class="req-list" id="reqList"></div>
            </div>
            <div class="tc">
              <div class="tc-lbl">Content Structure</div>
              <div class="struct-chain" id="structChain"></div>
              <div style="margin-top:16px">
                <div class="tc-lbl">Backup Format</div>
                <div id="backupFmt" style="font-size:11px;color:var(--ink2);margin-top:4px">—</div>
              </div>
            </div>
          </div>

          <!-- Platform specifics -->
          <div class="plat-box" id="platBox" style="display:none">
            <div class="plat-lbl" id="platBoxLbl">Platform Optimization</div>
            <div class="plat-items" id="platItems"></div>
          </div>

          <div class="card-reason" id="cardReason"></div>
        </div>

        <!-- Final Output -->
        <div class="final-card">
          <div class="final-hdr">
            <div class="final-hdr-l">
              <div class="final-eye">VYRALL Output</div>
              <div class="final-t">Final Script</div>
            </div>
            <div class="fbadge" id="fbadge">Waiting</div>
          </div>
          <div class="final-body" id="finalBody"></div>
        </div>

      </div>
    </div>

    <!-- HISTORY VIEW -->
    <div id="histView" class="hist-view">
      <div id="histContent"></div>
    </div>

  </main>
</div>

<script>
// ════════════════════════════════════════════════════════════════
// VYRALL COMPLETE VIRALITY KNOWLEDGE BASE v3
// All 8 layers — AI makes all strategic decisions autonomously
// ════════════════════════════════════════════════════════════════
const KB = `
=== VYRALL COMPLETE VIRALITY KNOWLEDGE BASE ===

LAYER 1 — BRENDAN KANE FRAMEWORK:
- Followers don't determine reach. Algorithms reward attention capture + retention.
- FORMAT (Macro): Repeatable storytelling skeleton. Doesn't guarantee performance alone.
- CONTEXT (Micro): Angle, framing, pacing, delivery INSIDE the format. Context = success or failure.
- 4 PERFORMANCE DRIVERS: (1) Perspective Shift — trigger "Wait…what?", avoid predictable. (2) Delivery & Credibility — concise, confident, no filler. (3) Hook Strength — 1-2 sentences, immediate tension, NO greetings. (4) Viewer Self-Reflection — viewer evaluates own life, builds to aha moment.
- ATTENTION RETENTION: Momentum always. No redundant sentences. Micro-hooks every 3-7s. Build to payoff.
- GOLD/SILVER/BRONZE: Difference between 54M and 276K views is perspective shift surprise, hook absurdity, delivery confidence, reflection depth.
- OUTPUT STRUCTURE: Hook → Perspective Shift → Core Explanation → Self-Reflection → Resolution/Payoff.
- PROHIBITED: Clichés, rambling intros, hooks >2 sentences, over-explaining, filler words.

LAYER 2 — JONAH BERGER'S STEPPS (Wharton):
- CRITICAL: HIGH-AROUSAL emotions drive sharing. LOW-AROUSAL emotions suppress sharing.
- HIGH-AROUSAL (use these): Awe, Anger, Anxiety/Fear, Amusement, Inspiration, Surprise.
- LOW-AROUSAL (avoid for virality): Sadness, Contentment, Nostalgia.
- A deeply moving sad piece underperforms because sadness is low-arousal even if emotionally resonant.
- EMOTION SELECTION RULES: Anger → injustice, systemic problems, myths that cost people. Awe → scale, unexpected beauty, counterintuitive greatness. Anxiety → risks, warnings, things people fear losing. Amusement → relatable absurdity, irony, universal human awkwardness. Inspiration → transformation, identity activation, possibility. Surprise → unexpected data, counterintuitive outcomes, plot twists.

LAYER 3 — SOCIAL CURRENCY THEORY:
- People share content that makes THEM look good to their own audience.
- Key question: "Will the viewer want to be SEEN sharing this?"
- Social currency types: INSIDER KNOWLEDGE (they know something others don't), INTELLIGENCE SIGNAL (signals taste/analytical ability), GROUP IDENTITY (membership in valued group), MORAL POSITIONING (they stand for right things), PRACTICAL WISDOM (helpful and resourceful).
- Design content so the SHARER gains social benefit from the act of sharing.
- Even great content won't spread if sharing doesn't benefit the sharer socially.

LAYER 4 — SHARE TRIGGER PSYCHOLOGY:
- Watching = low commitment. Sharing = viewer puts their own reputation behind the content.
- The gap between "great content" and "I'm sharing this" requires specific triggers:
  PRACTICAL_UTILITY: "This will help someone I know" — specific person comes to mind.
  SOCIAL_POSITIONING: "Sharing this makes me look smart/informed/ahead of the curve."
  IDENTITY_EXPRESSION: "This says something about who I am or want to be."
  MORAL_IMPERATIVE: "People NEED to know this" — righteous urgency.
  ENTERTAINMENT: "This will make someone laugh or feel something."
  INSIDER_KNOWLEDGE: "I have access to something not everyone knows."
- Strongest viral content activates 2-3 overlapping triggers simultaneously.

LAYER 5 — PLATFORM-SPECIFIC ALGORITHM MECHANICS:
TIKTOK: Completion rate + rewatch rate = primary signals. 30s watched twice > 2min watched once. First 0-3s determines algorithmic seeding. Native authentic aesthetic > polished production. Audio hook as important as visual hook.
YOUTUBE LONG-FORM: CTR from thumbnail = primary signal BEFORE watch time. Hook is actually the thumbnail. Watch time + session time determines reach. 40-70% CTR = excellent.
YOUTUBE SHORTS: Swipe-away rate in first 0-2s is critical. No slow builds. Loop-able endings increase completion.
INSTAGRAM REELS: Save rate = strong virality signal. Content people reference again gets algorithmic boost. Trending audio carries existing momentum.
INSTAGRAM CAROUSEL: First slide = hook. Each slide earns the next swipe. Last slide prompts save/share.
FACEBOOK: Shares and comments drive reach over likes. Emotionally triggering content spreads through personal networks. Long-form text posts perform well for authority/trust goals. Video autoplay — first 3 seconds must hook silently (many watch muted). Facebook Groups amplify content within tight communities — identity-based virality is powerful here. Reshare rate is the primary viral mechanic on Facebook.
LINKEDIN: Dwell time in COMMENTS > likes. Content generating debate gets compounding reach. First-degree engagement in first 60-90 min determines viral potential. Text with line breaks > pure video in many niches. End with question to drive comments.
TWITTER/X: Reply velocity in first 30 min = critical signal. Controversial/quotable/debatable > safe. Single strong idea > multi-idea. Bookmarks signal algorithmic value more than retweets.
NEWSLETTER: Subject line = only initial metric. Preview text = second hook. Write content worth forwarding.
PODCAST: First 90s determines listener commitment. Quotable single sentences worth sharing on social.

LAYER 6 — IDENTITY-BASED VIRALITY (NYU Social Identity Lab):
- Content aligned with GROUP IDENTITY spreads exponentially within that group regardless of production quality.
- Groups: professional identity, cultural/ethnic, religious, political, hobby/interest, aspirational.
- NICHE PARADOX: Hyper-specific niche content often goes more viral than broad content. Intense identification in smaller group seeds it outward aggressively.
- Design content to feel like it BELONGS to a specific tribe. Insiders share insider content.

LAYER 7 — NETWORK SEEDING THEORY:
- Where content starts matters as much as what the content is.
- High-connectivity nodes (diverse large networks) spread further than large clustered audiences.
- Design content to appeal to connectors who span multiple communities.
- First 100-500 people determine whether content escapes its origin community.

LAYER 8 — INFORMATION DENSITY & COMPRESSION:
- Optimal content: enough novelty to maintain attention, not so much cognitive load becomes aversive.
- SINGLE STRONG IDEA: One well-executed idea > multiple crammed together.
- COMPRESSION PRINCIPLE: Dense, compressed insights feel more intelligent and shareable.
- WORK-TO-WOW RATIO: Effort to reach the aha moment must be minimal. Friction kills sharing.
- Each sentence must add new value. No sentence repeats what was just said.

META RULES FOR AI ENGINE:
1. NEVER ask the user to choose emotion or share triggers — the AI must select these autonomously based on topic + goal + platform analysis.
2. Select the SINGLE highest-arousal emotion that authentically fits the topic. Don't force — match.
3. Activate 2-3 share triggers that naturally emerge from the topic and emotion combination.
4. Generate the punchiest, most optimized version FIRST. Never produce a mediocre draft for later optimization.
5. The output must satisfy ALL 8 layers simultaneously where possible.
6. Always think: "What would make this impossible NOT to share?"
`;

// ════════════════════════════════════════════════════════════════
// FORMATS
// ════════════════════════════════════════════════════════════════
const FMTS=[
  {n:"Man-on-the-Street",d:"Interview strangers in public; a real story unfolds in real time."},
  {n:"Walking Listicle",d:"Walk while delivering a numbered list of tips, rules, or mistakes."},
  {n:"Professional Advice",d:"Direct-to-camera scenario-based advice (When X happens, do Y)."},
  {n:"Absurd Success Stories",d:"Narrate unexpected, counterintuitive business or life success stories."},
  {n:"Philosophical FaceTime",d:"Intimate direct-to-camera reflections with quotes and emotional pacing."},
  {n:"Transformation / Before-After",d:"Dramatic change in body, business, mindset, or situation."},
  {n:"Storytime",d:"Compelling personal or third-party story with tension and payoff."},
  {n:"POV (Point-of-View)",d:"Viewer experiences the scenario as the protagonist."},
  {n:"Reaction",d:"Creator reacts to another video, news, or trend in real time."},
  {n:"Duet / Stitch",d:"Add commentary or continuation to another creator's video."},
  {n:"Zero-Click Educational",d:"Dense, self-contained info — no external link needed."},
  {n:"Carousel",d:"Multi-slide storytelling or teaching (swipe format)."},
  {n:"Short-Form Explainer",d:"Fast, punchy concept breakdown under 60 seconds."},
  {n:"Myth-Busting",d:"Debunk a widely-held misconception in your field."},
  {n:"Challenge / Trend",d:"Participate in or remix a trending challenge or audio."},
  {n:"Behind-the-Scenes (BTS)",d:"Show process, workflow, or daily life authentically."},
  {n:"Tutorial / How-To",d:"Step-by-step demonstration of a skill or process."},
  {n:"Testimonial / Social Proof",d:"Real people share results or experiences."},
  {n:"Skit / Micro-Drama",d:"Short comedic or dramatic reenactments of real situations."},
  {n:"Listicle Static",d:"Text-based lists presented visually as carousel or single image."},
  {n:"Live Q&A",d:"Answer audience questions in real time."},
  {n:"AMA (Ask Me Anything)",d:"Respond to audience questions in short video clips."},
  {n:"UGC (User-Generated Content)",d:"Content created by customers or fans about your work."},
  {n:"Meme / Humor",d:"Relatable humorous content using cultural references or situations."},
  {n:"Poll / Interactive",d:"Ask the audience to vote, choose, or respond to a scenario."},
  {n:"Narrative Hook",d:"Opens with 'I bet you didn't know…' — a curiosity trigger."},
  {n:"Countdown / Timer",d:"Use a countdown or timer to build urgency or structure."},
  {n:"Silent / Text-Only",d:"No talking — only captions, visuals, and music carry the message."},
  {n:"Split-Screen Comparison",d:"Side-by-side comparison of two ideas, approaches, or outcomes."},
  {n:"Things I Wish I Knew Earlier",d:"Lessons learned with emotional resonance and personal stakes."},
  {n:"3 Mistakes You're Making",d:"Fast list of common errors followed by actionable fixes."},
  {n:"Day in the Life",d:"Document a real daily routine with authentic moments."},
  {n:"Product Demo",d:"Show a product in action with clear, tangible value."},
  {n:"Case Study",d:"Break down a real example with process, challenges, and results."},
  {n:"Countdown Storytelling",d:"Tell a story in reverse order (3…2…1) for suspense."},
  {n:"If You Struggle With X, Watch This",d:"Target a specific pain point with empathy and solutions."},
  {n:"I Tried X for 30 Days",d:"Document a personal challenge or experiment with honest results."},
  {n:"Here's What No One Tells You About…",d:"Reveal hidden truths or insider knowledge."},
  {n:"Stop Doing This",d:"Call out a harmful habit or costly mistake directly."},
  {n:"Do This Instead",d:"Offer a clearly better alternative to a common behavior."},
];

const REQS_MAP={
  "Man-on-the-Street":["<strong>Authentic reactions</strong> — stranger's unscripted response is the payoff","<strong>Simple, clear premise</strong> — understood in under 3 seconds","<strong>Story arc in under 90s</strong> — setup, encounter, revelation","<strong>Unexpected outcome</strong> — the aha moment must surprise","<strong>Keep real pauses</strong> — don't over-polish the edit"],
  "Walking Listicle":["<strong>State the number upfront</strong> — '3 things that…' in the first line","<strong>Each point is a micro-hook</strong> — stands alone with its own tension","<strong>Counterintuitive order</strong> — bury gold in the middle","<strong>Cadence matches movement</strong> — pace words to walking rhythm","<strong>No filler between points</strong> — cut immediately to next item"],
  "Philosophical FaceTime":["<strong>Intimate framing</strong> — feels like FaceTime, not a broadcast","<strong>Opens with a timeless idea</strong> — universally true concept","<strong>Anchor with an outside reference</strong> — something larger than your own voice","<strong>Three-part build</strong> — triadic structure (time, distance, silence)","<strong>Slow, deliberate pacing</strong> — emotional resonance needs space","<strong>Perspective shift non-negotiable</strong> — common idea reframed uncommonly"],
  "Myth-Busting":["<strong>State the myth directly</strong> — don't bury it in setup","<strong>The perspective shift IS the format</strong> — if viewer already knows it's false, not viral","<strong>Your authority must be clear</strong> — why are YOU busting this?","<strong>High stakes</strong> — the myth must be costing people something real","<strong>Replace, don't just destroy</strong> — end with the correct belief"],
  "Storytime":["<strong>Open with the dramatic peak</strong> — start at most intense moment","<strong>Specific sensory details</strong> — time, place, exact words said","<strong>Clear antagonist or obstacle</strong> — conflict drives retention","<strong>Turning point / realization</strong> — this is the payoff","<strong>Emotional honesty</strong> — vulnerability builds trust; polish kills relatability"],
  "Absurd Success Stories":["<strong>The absurdity IS the hook</strong> — more unexpected = better","<strong>Specific numbers and details</strong> — vague stories never go viral","<strong>Name the strategy or pattern</strong> — 'I'm calling this the X strategy'","<strong>Transferable insight</strong> — viewer must see how to apply it","<strong>No slow build</strong> — get to the absurdity in the first 5 seconds"],
};

const DEF_REQS=[
  "<strong>Perspective shift in first 3 seconds</strong> — angle viewer hasn't seen",
  "<strong>Hook creates immediate tension</strong> — no greetings, no preamble",
  "<strong>Viewer self-reflection built in</strong> — viewer evaluates their own situation",
  "<strong>Tight, confident delivery</strong> — no filler, no redundancy",
  "<strong>Clear payoff or aha moment</strong> — every sentence earns its place",
  "<strong>Micro-hooks every 3-7 seconds</strong> — prevent drop-off",
];

const PLAT_TIPS={
  tiktok:["Completion rate + rewatch rate are the primary algorithm signals","30s watched twice outweighs 2min watched once — optimize for loops","First 0-3 seconds determine algorithmic seeding — no slow builds","Audio hook matters as much as visual hook — design for sound-on"],
  youtube_longform:["CTR from thumbnail is the primary metric — thumbnail IS the real hook","Watch time + session time (does viewer watch more after?) determines reach","First 30 seconds must justify the full video length","Use chapter markers — viewers who skip still register watch time"],
  youtube_shorts:["Swipe-away rate in first 2 seconds is critical — visual hook immediately","Loop-able endings dramatically increase completion rate","No slow builds — get to the perspective shift in the first second","Captions required — large portion watch muted"],
  instagram_reels:["Save rate is a stronger signal than likes — design content worth saving","Trending audio carries existing algorithmic momentum","Caption text is a second script — many watch muted","Rewatch hooks: end in a way that makes viewers want to see it again"],
  instagram_carousel:["First slide is the hook — must compel the swipe before anything else","Each slide earns the next swipe — micro-hook per slide","Last slide should prompt a save or share action explicitly","Text-heavy carousels outperform image-only for educational niches"],
  facebook:["Reshare rate is the primary viral mechanic — design content people send to specific people","First 3 seconds must hook silently — autoplay starts muted","Facebook Groups amplify identity-based content — tribal resonance is powerful here","Shares + comments drive reach far more than likes","Emotional content (anger, awe, moral imperative) spreads through personal networks","Long-form text posts perform well for authority and trust goals"],
  linkedin:["Dwell time in comments outweighs likes — design for debate and discussion","First-degree engagement in first 60-90 mins determines viral potential","End every post with a question — drives comments, which drives reach","Text with deliberate line breaks consistently outperforms pure video in professional niches"],
  twitter_x:["Reply velocity in first 30 minutes is the critical signal","Controversial, quotable, or debatable content drives replies over likes","Single strong idea outperforms multi-idea threads for reach","Bookmarks now signal algorithmic value more than retweets"],
  newsletter:["Subject line is the only metric that matters initially — it IS the hook","Preview text is the second hook — never waste it","Write content worth forwarding — that is the viral mechanism on email","Specificity in subject lines beats cleverness every time"],
  podcast:["First 90 seconds determine if listener commits — no slow intros","Quotable single sentences worth clipping and sharing on social","Guest credibility or topic specificity drives shares over production quality","Episode titles follow identical hook rules as video hooks"],
};

// ════════════════════════════════════════════════════════════════
// INIT
// ════════════════════════════════════════════════════════════════
(()=>{
  const l=document.getElementById('fmtList');
  FMTS.forEach((f,i)=>{
    const d=document.createElement('div');d.className='fe';
    d.innerHTML=`<div><span class="fe-n">${String(i+1).padStart(2,'0')}. </span><span class="fe-nm">${f.n}</span></div><div class="fe-d">${f.d}</div>`;
    l.appendChild(d);
  });
})();

function togAcc(b,c){document.getElementById(b).classList.toggle('open');document.getElementById(c).classList.toggle('open');}

let offerOn=false, curScript='', curCta='', curFmtData=null, curEmo='';

function togOffer(){
  offerOn=!offerOn;
  document.getElementById('offerTog').classList.toggle('on',offerOn);
  document.getElementById('offerF').classList.toggle('vis',offerOn);
}

function sw(v){
  document.getElementById('genView').style.display=v==='gen'?'block':'none';
  document.getElementById('histView').classList.toggle('vis',v==='hist');
  document.getElementById('nb-gen').classList.toggle('on',v==='gen');
  document.getElementById('nb-hist').classList.toggle('on',v==='hist');
  if(v==='hist') renderHist();
}

function setSt(s,t){
  document.getElementById('sdot').className='sdot '+(s||'');
  document.getElementById('stxt').textContent=t||'Ready';
}

function setBadge(s,t){
  const b=document.getElementById('fbadge');
  b.textContent=t||s; b.className='fbadge '+(s||'');
}

// ════════════════════════════════════════════════════════════════
// API
// ════════════════════════════════════════════════════════════════
async function ai(system,user){
  const r=await fetch("/.netlify/functions/claude",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({system,user})
  });
  const d=await r.json();
  if(d.error)throw new Error(d.error);
  return d.text;
}

function pj(txt){
  const c=txt.replace(/```json|```/g,'').trim();
  try{return JSON.parse(c);}catch(e){
    const m=c.match(/\{[\s\S]*\}/);if(m)return JSON.parse(m[0]);throw e;
  }
}

// ════════════════════════════════════════════════════════════════
// RENDER ANALYSIS
// ════════════════════════════════════════════════════════════════
const EMO_COLORS={awe:'emo-awe',anger:'emo-anger',anxiety:'emo-anxiety',amusement:'emo-amusement',inspiration:'emo-inspiration',surprise:'emo-surprise'};

function renderAnalysis(data){
  document.getElementById('fmtBadge').textContent=data.primary_format||'—';
  document.getElementById('backupFmt').textContent='Backup: '+(data.backup_format||'—');
  document.getElementById('cardReason').textContent=data.reason||'';

  // Animate scores
  const sc=data.scores||{};
  const animate=(barId,valId,pct)=>{setTimeout(()=>{document.getElementById(barId).style.width=pct+'%';document.getElementById(valId).textContent=pct+'%';},100);};
  animate('sb-hook','sv-hook',sc.hook_strength||0);
  animate('sb-emo','sv-emo',sc.emotion_arousal||0);
  animate('sb-share','sv-share',sc.share_trigger||0);
  animate('sb-plat','sv-plat',sc.platform_fit||0);

  // AI Selections — shown transparently
  const emo=data.selected_emotion||'';
  curEmo=emo;
  const emoEl=document.getElementById('as-emo');
  emoEl.textContent=emo?(emo.charAt(0).toUpperCase()+emo.slice(1)):'—';
  emoEl.className='as-val '+(EMO_COLORS[emo]||'');
  document.getElementById('as-emo-why').textContent=data.emotion_reasoning||'';

  // Triggers
  const trigs=data.selected_triggers||[];
  document.getElementById('as-trigs').innerHTML=trigs.map(t=>`<span class="trig-tag">${t.replace(/_/g,' ')}</span>`).join('');
  document.getElementById('as-trigs-why').textContent=data.trigger_reasoning||'';
  document.getElementById('as-social').textContent=data.social_currency_strategy||'';

  // Insights
  document.getElementById('insightsRow').innerHTML=(data.insights||[]).map(i=>`
    <span class="ip ${i.type||'info'}">${i.type==='good'?'✓':i.type==='warn'?'⚠':'→'} ${i.text}</span>`).join('');

  // Structure
  document.getElementById('structChain').innerHTML=(data.recommended_structure||[]).map((s,i,a)=>
    `<span class="sc-step">${s}</span>${i<a.length-1?'<span class="sc-arr">→</span>':''}`
  ).join('');

  // Requirements
  const reqs=REQS_MAP[data.primary_format]||data.format_requirements||DEF_REQS;
  document.getElementById('reqList').innerHTML=reqs.map(r=>`
    <div class="req-item"><div class="req-dash">—</div><div class="req-txt">${r}</div></div>`).join('');

  // Platform tips
  const platVal=document.getElementById('platSel').value;
  const tips=PLAT_TIPS[platVal]||(data.platform_tips||[]);
  const pb=document.getElementById('platBox');
  if(tips.length&&platVal!=='any'){
    pb.style.display='block';
    document.getElementById('platBoxLbl').textContent=document.getElementById('platSel').selectedOptions[0].text+' — Algorithm Tips';
    document.getElementById('platItems').innerHTML=tips.map(t=>`<div class="plat-item">${t}</div>`).join('');
  } else {
    pb.style.display='none';
  }
}

// ════════════════════════════════════════════════════════════════
// RENDER FINAL
// ════════════════════════════════════════════════════════════════
function renderFinal(data,hasOffer){
  const body=document.getElementById('finalBody');
  const script=data.aligned_script||data.script||'';
  const cta=data.cta||'';
  curScript=script; curCta=cta;

  const hm=script.match(/^(.{20,250}?[.!?])\n\n([\s\S]+)$/);
  let hookHtml='',bodyTxt=script;
  if(hm){hookHtml=`<div class="hook-block"><div class="hook-tag">Hook</div><div class="hook-txt">${hm[1]}</div></div>`;bodyTxt=hm[2];}

  const ctaHtml=hasOffer&&cta
    ?`<div class="cta-block"><div class="cta-lbl">Call To Action</div><div class="cta-txt">${cta}</div></div>`
    :!hasOffer?`<div class="no-offer">No offer promotion — pure value content. Enable "I have an offer" to add a CTA.</div>`:'';

  const shareHtml=data.share_explanation?`<div class="share-block"><div class="share-lbl">Why They'll Share It</div><div class="share-txt">${data.share_explanation}</div></div>`:'';

  const full=script+(cta?'\n\n'+cta:'');

  body.innerHTML=`
    ${hookHtml}
    <div class="script-b">${bodyTxt.replace(/\n/g,'<br>')}</div>
    ${ctaHtml}
    ${shareHtml}
    <div class="act-row">
      <div class="act-g">
        <button class="abtn" id="ab-hook" onclick="regenHook()">↺ New Hook</button>
        <button class="abtn" id="ab-regen" onclick="regenFull()">↺ Regenerate</button>
        <button class="abtn" id="ab-emo" onclick="shiftEmo()">◈ Shift Emotion</button>
      </div>
      <div class="act-g">
        <button class="abtn" onclick="copyTxt(this,${JSON.stringify(full)})">Copy</button>
        <button class="abtn primary" onclick="copyTxt(this,${JSON.stringify(full)})">Copy Script</button>
      </div>
    </div>`;
}

function skeleton(){
  document.getElementById('finalBody').innerHTML=`<div class="skel-wrap">${['52%','88%','70%','93%','64%','81%','44%','75%'].map(w=>`<div class="sk" style="width:${w}"></div>`).join('')}</div>`;
}

function disAbs(d){['ab-hook','ab-regen','ab-emo'].forEach(id=>{const e=document.getElementById(id);if(e)e.disabled=d;});}

function copyTxt(btn,txt){
  navigator.clipboard.writeText(txt).then(()=>{const o=btn.textContent;btn.textContent='Copied ✓';setTimeout(()=>btn.textContent=o,2000);});
}

// ════════════════════════════════════════════════════════════════
// HISTORY
// ════════════════════════════════════════════════════════════════
async function saveHist(entry){
  try{
    const r=await window.storage.get('vyrall:idx').catch(()=>null);
    const ids=r?JSON.parse(r.value):[];
    const id='vyrall:i:'+Date.now();
    await window.storage.set(id,JSON.stringify(entry));
    ids.unshift(id);
    await window.storage.set('vyrall:idx',JSON.stringify(ids.slice(0,20)));
    updHC(ids.length);
  }catch(e){}
}

async function loadHistItems(){
  try{
    const r=await window.storage.get('vyrall:idx').catch(()=>null);
    if(!r)return[];
    const ids=JSON.parse(r.value);const items=[];
    for(const id of ids){try{const x=await window.storage.get(id);if(x)items.push({id,...JSON.parse(x.value)});}catch(e){}}
    return items;
  }catch(e){return[];}
}

async function delHist(id){
  try{
    await window.storage.delete(id);
    const r=await window.storage.get('vyrall:idx').catch(()=>null);
    if(!r)return;
    const ids=JSON.parse(r.value).filter(x=>x!==id);
    await window.storage.set('vyrall:idx',JSON.stringify(ids));
    updHC(ids.length);renderHist();
  }catch(e){}
}

function updHC(n){document.getElementById('hc').textContent=n>0?`(${n})`:''; }
function timeAgo(ts){if(!ts)return'';const d=Date.now()-ts;const m=Math.floor(d/60000),h=Math.floor(d/3600000),dy=Math.floor(d/86400000);if(m<1)return'just now';if(m<60)return`${m}m ago`;if(h<24)return`${h}h ago`;return`${dy}d ago`;}

async function renderHist(){
  const c=document.getElementById('histContent');
  c.innerHTML='<div style="color:var(--ink3);font-size:11px;padding:20px">Loading…</div>';
  const items=await loadHistItems();updHC(items.length);
  if(!items.length){c.innerHTML=`<div class="hist-empty"><div style="font-size:36px;opacity:.3">◈</div><div style="font-size:13px">No saved content yet</div><div style="font-size:11px">Generate something and it'll appear here</div></div>`;return;}
  c.innerHTML='';
  const list=document.createElement('div');list.className='hist-list';
  items.forEach(item=>{
    const el=document.createElement('div');el.className='hi';
    const prev=(item.hook||item.aligned_script||'').substring(0,150)+'…';
    el.innerHTML=`
      <div class="hi-hdr">
        <div><div class="hi-topic">${item.topic||'Untitled'}</div><div class="hi-meta">${item.format||''} · ${item.goal||''} · ${item.platform||''}</div></div>
        <div class="hi-time">${timeAgo(item.timestamp)}</div>
      </div>
      <div class="hi-prev">${prev}</div>
      <div class="hi-tags">
        ${item.emotion?`<span class="hi-tag">◈ ${item.emotion}</span>`:''}
        ${(item.triggers||[]).map(t=>`<span class="hi-tag">${t.replace(/_/g,' ')}</span>`).join('')}
      </div>
      <div class="hi-acts">
        <button class="hbtn hl" onclick="loadHI('${item.id}')">Load &amp; View</button>
        <button class="hbtn" onclick="cpyHI('${item.id}')">Copy</button>
        <button class="hbtn" onclick="delHist('${item.id}')">Delete</button>
      </div>`;
    list.appendChild(el);
  });
  c.appendChild(list);
}

async function loadHI(id){
  try{
    const r=await window.storage.get(id);if(!r)return;
    const item=JSON.parse(r.value);sw('gen');
    document.getElementById('welcomeEl').style.display='none';
    document.getElementById('outEl').style.display='flex';
    if(item.fmtData)renderAnalysis(item.fmtData);
    if(item.aligned_script){renderFinal({aligned_script:item.aligned_script,cta:item.cta||'',share_explanation:item.share_explanation||''},!!item.cta);setBadge('ok','✦ Loaded from History');}
  }catch(e){}
}

async function cpyHI(id){
  try{const r=await window.storage.get(id);if(!r)return;const i=JSON.parse(r.value);navigator.clipboard.writeText((i.aligned_script||'')+(i.cta?'\n\n'+i.cta:''));}catch(e){}
}

// ════════════════════════════════════════════════════════════════
// REGEN ACTIONS
// ════════════════════════════════════════════════════════════════
const SYS=()=>`${KB}\nYou are VYRALL's AI engine. Apply ALL 8 virality layers. Select emotion and triggers autonomously. Return ONLY valid JSON.`;

async function regenHook(){
  if(!curScript)return;
  disAbs(true);setBadge('run','Rewriting hook…');setSt('run','Rewriting hook…');
  try{
    const raw=await ai(SYS(),`HOOK OPTIMIZER. Topic context from current script. Selected emotion was: ${curEmo}.
Rewrite ONLY the hook using Layers 1-4. Must trigger "Wait…what?" Must activate ${curEmo} emotion in the first 2 words. 1-2 sentences max. No greetings.
Current full script: ${curScript}
Return JSON: {"improved_hook":"...","reason":"one sentence on why this hook is stronger"}`);
    const d=pj(raw);
    const ns=d.improved_hook+'\n\n'+curScript.replace(/^.+?\n\n/,'');
    curScript=ns;renderFinal({aligned_script:ns,cta:curCta},!!curCta);
    setBadge('ok','✦ Hook Updated');setSt('ok','Done');
  }catch(e){setBadge('fail','Error');setSt('fail','Failed');}
  disAbs(false);
}

async function regenFull(){
  const topic=document.getElementById('topicInput').value.trim();
  if(!topic){run();return;}
  disAbs(true);setBadge('run','Regenerating…');setSt('run','Regenerating…');skeleton();
  try{
    const goalTxt=document.getElementById('goalSel').selectedOptions[0].text;
    const toneTxt=document.getElementById('toneSel').selectedOptions[0].text;
    const platTxt=document.getElementById('platSel').selectedOptions[0].text;
    const offer=offerOn?document.getElementById('offerIn').value.trim():'';
    const cta=offerOn?document.getElementById('ctaIn').value.trim():'';
    const fmt=curFmtData?curFmtData.primary_format:'best fit';
    const raw=await ai(SYS(),`FULL REGENERATION — completely different angle. Do NOT reuse any phrasing from the original.
Topic:"${topic}" | Goal:${goalTxt} | Tone:${toneTxt} | Platform:${platTxt} | Format:${fmt}
${offer?`Offer:"${offer}" | CTA:"${cta||'natural next step'}"`: 'No offer — pure value.'}
Original (avoid entirely): ${curScript.substring(0,200)}…
Select optimal emotion autonomously. Activate 2-3 share triggers. Generate punchiest possible version. Apply all 8 layers.
Return JSON:{"aligned_script":"...","cta":"${offer?'...':''}","share_explanation":"one sentence on which share trigger fires and why"}`);
    const d=pj(raw);renderFinal(d,offerOn&&!!offer);
    setBadge('ok','✦ Regenerated');setSt('ok','Done');
    await saveHist({topic,format:fmt,goal:goalTxt,platform:document.getElementById('platSel').value,emotion:curEmo,triggers:curFmtData?.selected_triggers||[],timestamp:Date.now(),aligned_script:d.aligned_script,cta:d.cta||'',share_explanation:d.share_explanation||'',hook:d.aligned_script.split('\n\n')[0],fmtData:curFmtData});
  }catch(e){setBadge('fail','Error');setSt('fail','Failed');document.getElementById('finalBody').innerHTML=`<div class="err-msg">${e.message}</div>`;}
  disAbs(false);
}

async function makePunchy(){
  if(!curScript)return;
  disAbs(true);setBadge('run','Punching up…');setSt('run','Punching up…');
  try{
    const raw=await ai(SYS(),`COMPRESSION OPTIMIZER (Layer 8). Make this script significantly punchier.
Strip every filler word. Shorten every sentence to its minimum viable form. Increase tension. Add micro-hooks between paragraphs. Remove anything that doesn't add new value. Single strong idea per section. Work-to-wow ratio must be effortless.
Current script: ${curScript}
Return JSON:{"aligned_script":"...","cta":"${curCta||''}"}`);
    const d=pj(raw);curScript=d.aligned_script;
    renderFinal(d,!!curCta);setBadge('ok','⚡ Punchier');setSt('ok','Done');
  }catch(e){setBadge('fail','Error');setSt('fail','Failed');}
  disAbs(false);
}

async function shiftEmo(){
  if(!curScript)return;
  disAbs(true);
  const emos=['awe','anger','anxiety','amusement','inspiration','surprise'];
  const next=emos.find(e=>e!==curEmo)||'awe';
  setBadge('run',`Shifting to ${next}…`);setSt('run',`Shifting emotion to ${next}…`);
  try{
    const raw=await ai(SYS(),`EMOTION SHIFT. Rewrite this script to trigger ${next} instead of ${curEmo||'current emotion'}.
Per Berger's STEPPS, ${next} is high-arousal and drives sharing. Reframe the same core idea through the lens of ${next}. Same topic, same insight, completely different emotional mechanism.
Current script: ${curScript}
Return JSON:{"aligned_script":"...","cta":"${curCta||''}"}`);
    const d=pj(raw);curScript=d.aligned_script;curEmo=next;
    // Update AI selection display
    const emoEl=document.getElementById('as-emo');
    emoEl.textContent=next.charAt(0).toUpperCase()+next.slice(1);
    emoEl.className='as-val '+(EMO_COLORS[next]||'');
    document.getElementById('as-emo-why').textContent=`Manually shifted to ${next} for exploration.`;
    renderFinal(d,!!curCta);setBadge('ok',`◈ ${next} applied`);setSt('ok','Done');
  }catch(e){setBadge('fail','Error');setSt('fail','Failed');}
  disAbs(false);
}

// ════════════════════════════════════════════════════════════════
// MAIN PIPELINE
// ════════════════════════════════════════════════════════════════
async function run(){
  const topic=document.getElementById('topicInput').value.trim();
  const niche=document.getElementById('nicheInput').value.trim();
  const goalTxt=document.getElementById('goalSel').selectedOptions[0].text;
  const toneTxt=document.getElementById('toneSel').selectedOptions[0].text;
  const platVal=document.getElementById('platSel').value;
  const platTxt=document.getElementById('platSel').selectedOptions[0].text;
  const offer=offerOn?document.getElementById('offerIn').value.trim():'';
  const cta=offerOn?document.getElementById('ctaIn').value.trim():'';

  if(!topic){
    const i=document.getElementById('topicInput');
    i.classList.add('err');i.focus();setTimeout(()=>i.classList.remove('err'),1800);return;
  }

  const btn=document.getElementById('runBtn');
  btn.disabled=true;btn.textContent='⟳ Generating…';
  document.getElementById('welcomeEl').style.display='none';
  document.getElementById('outEl').style.display='flex';
  skeleton();setBadge('run','Analyzing…');setSt('run','Running virality intelligence…');

  const SYS_P=`${KB}\nYou are VYRALL's AI engine. Apply ALL 8 virality layers. Autonomously select the optimal emotion and share triggers — never ask the user. Return ONLY valid JSON.`;

  // ── STEP 1: ANALYSIS + FORMAT SELECTION ──────────────────
  let fmtData;
  try{
    const raw=await ai(SYS_P,`
VIRALITY INTELLIGENCE ANALYSIS — apply all 8 layers.
Topic: "${topic}"
Niche: "${niche||'general'}"
Goal: ${goalTxt}
Tone: ${toneTxt}
Platform: ${platTxt}

YOUR TASKS:
1. Select the single best storytelling format (Kane Layer 1 Format Matrix).
2. Autonomously select the OPTIMAL high-arousal emotion for this specific topic+goal combination (Layer 2). Choose based on: Anger→injustice/systemic problems, Awe→scale/unexpected greatness, Anxiety→risks/warnings, Amusement→relatable absurdity, Inspiration→transformation/identity, Surprise→counterintuitive outcomes.
3. Autonomously select 2-3 share triggers that naturally emerge from this topic+emotion combination (Layer 4).
4. Define social currency strategy — how does sharing this benefit the SHARER socially? (Layer 3).
5. Score the content plan on 4 dimensions (0-100).
6. Generate 4 strategic insights (mix of good/info/warn).
7. Generate 5 specific format requirements for this exact format+goal combination.

FORMAT MATRIX: Virality→Walking Listicle, Myth-Busting, Narrative Hook, Absurd Success Story, Short-Form Explainer | Authority→Professional Advice, Zero-Click Educational, Case Study, Tutorial | Trust→Philosophical FaceTime, Storytime, Day in Life | Sales→Testimonial, Case Study, If You Struggle, BTS | Relatability→POV, Skit, Man-on-Street, 3 Mistakes | Inspiration→Transformation, Things I Wish I Knew, Absurd Success Story

Return JSON:
{
  "primary_format": "...",
  "backup_format": "...",
  "reason": "2-3 sentences: why this exact format for this topic+goal+emotion+platform combination",
  "recommended_structure": ["Hook","Perspective Shift","...","Payoff"],
  "format_requirements": ["req with <strong>bold term</strong> — explanation","...x5"],
  "selected_emotion": "awe|anger|anxiety|amusement|inspiration|surprise",
  "emotion_reasoning": "one sentence: why this emotion is optimal for this specific topic",
  "selected_triggers": ["trigger1","trigger2"],
  "trigger_reasoning": "one sentence: why these triggers will activate for this content",
  "social_currency_strategy": "one sentence: how sharing this makes the sharer look good",
  "scores": {"hook_strength":0,"emotion_arousal":0,"share_trigger":0,"platform_fit":0},
  "insights": [{"type":"good","text":"..."},{"type":"good","text":"..."},{"type":"info","text":"..."},{"type":"warn","text":"..."}]
}`);
    fmtData=pj(raw);curFmtData=fmtData;curEmo=fmtData.selected_emotion||'';
    if(!REQS_MAP[fmtData.primary_format]&&fmtData.format_requirements){REQS_MAP[fmtData.primary_format]=fmtData.format_requirements;}
    renderAnalysis(fmtData);
    setSt('run','Writing optimized content…');
  }catch(e){
    setBadge('fail','Error');setSt('fail','Analysis failed');
    document.getElementById('finalBody').innerHTML=`<div class="err-msg">Analysis failed: ${e.message}</div>`;
    btn.disabled=false;btn.textContent='▶ Generate Content';return;
  }

  // ── STEP 2: GENERATE PUNCHIEST FIRST-TIME OUTPUT ─────────
  try{
    const prompt=offer?`
CONTENT GENERATION — produce the punchiest, most optimized version possible. This is the FINAL version, not a draft.

Topic: "${topic}"
Niche: "${niche||'general'}"
Goal: ${goalTxt}
Tone: "${toneTxt}" — embody this unmistakably in every word and sentence rhythm
Platform: ${platTxt}
Format: ${fmtData.primary_format}
Structure: ${(fmtData.recommended_structure||[]).join(' → ')}
Selected emotion: ${fmtData.selected_emotion} — this must be viscerally FELT, not mentioned
Selected share triggers: ${(fmtData.selected_triggers||[]).join(', ')} — activate these naturally
Social currency goal: ${fmtData.social_currency_strategy}
Offer: "${offer}"
CTA: "${cta||'natural next step'}"

GENERATION RULES (all 8 layers applied simultaneously):
— Hook: 1-2 sentences. Trigger "Wait…what?" in the first 3 words. No greetings. Immediate tension.
— Perspective Shift: The single most surprising, counterintuitive angle available. NOT what they expect.
— Core: Tight, compressed, every sentence adds new value. Nothing redundant.
— Self-Reflection: Make the viewer evaluate their own life situation specifically.
— Payoff: Clear, satisfying, memorable. The viewer should feel the aha moment physically.
— Micro-hooks: Built in every 3-7 seconds of spoken content.
— Emotion ${fmtData.selected_emotion}: Must be activated through word choice, rhythm, and framing — not stated.
— Platform ${platTxt}: Optimize specifically for this platform's algorithm mechanics.
— Offer alignment: Weave naturally. CTA feels like something the viewer would seek themselves. No hard sell.
— Social currency: The sharer gains social benefit. Design for the sharer, not just the viewer.

Return JSON:
{
  "aligned_script": "full final script including hook — the complete, publish-ready piece",
  "cta": "standalone CTA sentence",
  "share_explanation": "one sentence: which trigger fires first and the exact psychological reason they'll forward this"
}`
    :`
CONTENT GENERATION — produce the punchiest, most optimized version possible. This is the FINAL version, not a draft.

Topic: "${topic}"
Niche: "${niche||'general'}"
Goal: ${goalTxt}
Tone: "${toneTxt}" — embody this unmistakably in every word and sentence rhythm
Platform: ${platTxt}
Format: ${fmtData.primary_format}
Structure: ${(fmtData.recommended_structure||[]).join(' → ')}
Selected emotion: ${fmtData.selected_emotion} — must be viscerally FELT
Selected share triggers: ${(fmtData.selected_triggers||[]).join(', ')} — activate naturally
Social currency goal: ${fmtData.social_currency_strategy}
No offer — pure value content.

GENERATION RULES (all 8 layers applied simultaneously):
— Hook: 1-2 sentences. "Wait…what?" in first 3 words. No greetings. Immediate tension.
— Perspective Shift: Most surprising angle available. NOT what they expect to hear.
— Core: Tight, compressed, every sentence adds new value. Nothing redundant.
— Self-Reflection: Viewer evaluates their own life situation specifically.
— Payoff: Clear, satisfying, memorable aha moment.
— Micro-hooks: Every 3-7 seconds of spoken content.
— Emotion ${fmtData.selected_emotion}: Activated through word choice and rhythm — never stated.
— Platform ${platTxt}: Optimize for this platform's specific algorithm mechanics.
— End: Thought-provoking statement or question that makes viewer reflect AND want to share.
— Social currency: The sharer looks good for forwarding this. Design for the sharer.

Return JSON:
{
  "aligned_script": "full final script including hook",
  "cta": "",
  "share_explanation": "one sentence: which trigger fires and exact psychological reason they'll forward this"
}`;

    const raw=await ai(SYS_P,prompt);
    const fd=pj(raw);
    renderFinal(fd,offerOn&&!!offer);
    setBadge('ok','✦ Ready');setSt('ok','Done');

    await saveHist({
      topic,format:fmtData.primary_format,
      goal:goalTxt,platform:platVal,
      emotion:fmtData.selected_emotion,
      triggers:fmtData.selected_triggers||[],
      timestamp:Date.now(),
      aligned_script:fd.aligned_script,cta:fd.cta||'',
      share_explanation:fd.share_explanation||'',
      hook:fd.aligned_script.split('\n\n')[0],
      fmtData
    });

  }catch(e){
    setBadge('fail','Error');setSt('fail','Generation failed');
    document.getElementById('finalBody').innerHTML=`<div class="err-msg">Content generation failed: ${e.message}</div>`;
  }

  btn.disabled=false;btn.textContent='▶ Generate Content';
}

// Init history count
(async()=>{try{const r=await window.storage.get('vyrall:idx').catch(()=>null);if(r){const ids=JSON.parse(r.value);updHC(ids.length);}}catch(e){}})();
</script>
</body>
</html>
